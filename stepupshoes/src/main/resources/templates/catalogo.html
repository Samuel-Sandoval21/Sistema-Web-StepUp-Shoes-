<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/header :: head}"></head>

<body>

<div th:replace="~{fragments/header :: header}"></div>

<main class="container my-5">

    <h1 class="mb-4">üõçÔ∏è Cat√°logo de Productos</h1>
    
    <!-- ‚úÖ Estado de Firebase -->
    <div class="alert alert-info" th:if="${usarFirebase}">
        <small>üì° Im√°genes cargadas desde Firebase Storage</small>
    </div>
    <div class="alert alert-warning" th:unless="${usarFirebase}">
        <small>üìÅ Im√°genes cargadas localmente</small>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <h3 class="mb-3">Filtrar Productos</h3>
            <form method="GET" action="/catalogo" class="row g-3" id="filtroForm">
                <!-- B√∫squeda -->
                <div class="col-md-12">
                    <label class="form-label">Buscar Producto</label>
                    <div class="input-group">
                        <input type="text" name="busqueda" class="form-control" id="busquedaInput"
                               placeholder="Escribe el nombre o descripci√≥n del producto..."
                               th:value="${param.busqueda}">
                        <button class="btn btn-outline-primary" type="submit" id="btnBuscar">
                            üîç Buscar
                        </button>
                    </div>
                </div>
                <!-- Mant√©n tus selects igual -->
                <div class="col-md-4">
                    <label class="form-label">Categor√≠a</label>
                    <select name="categoria" class="form-select" id="categoriaSelect">
                        <option value="">Todas</option>
                        <option th:each="cat : ${categorias}" 
                                th:value="${cat.nombre}" 
                                th:text="${cat.nombre}"
                                th:selected="${param.categoria != null && param.categoria == cat.nombre}">
                        </option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rango de Precio</label>
                    <select name="rangoPrecio" class="form-select" id="precioSelect">
                        <option value="">Todos</option>
                        <option value="0-50" th:selected="${param.rangoPrecio == '0-50'}">$0 - $50</option>
                        <option value="50-100" th:selected="${param.rangoPrecio == '50-100'}">$50 - $100</option>
                        <option value="100+" th:selected="${param.rangoPrecio == '100+'}">+$100</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Ordenar por</label>
                    <select name="orden" class="form-select" id="ordenSelect">
                        <option value="nombre-asc" th:selected="${param.orden == 'nombre-asc' || param.orden == null}">Nombre A-Z</option>
                        <option value="precio-asc" th:selected="${param.orden == 'precio-asc'}">Precio Menor a Mayor</option>
                        <option value="precio-desc" th:selected="${param.orden == 'precio-desc'}">Precio Mayor a Menor</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚úÖ Contador de productos -->
    <div class="alert alert-light mb-3">
        <strong th:text="${productos.size()}">0</strong> productos encontrados
    </div>

    <!-- ‚úÖ Productos - VERSI√ìN CORREGIDA -->
    <div class="row" id="productosContainer">
        <div class="col-lg-4 col-md-6 mb-4"
             th:each="producto, stat : ${productos}"
             th:attr="data-id=${producto.id}"
             th:class="${stat.index % 3 == 0} ? 'clearfix' : ''">
            
            <div class="card h-100 shadow-sm border-0">
                
                <!-- ‚úÖ UNA SOLA IMAGEN con carga inteligente -->
                <div class="image-container" style="height: 220px; overflow: hidden; background: #f8f9fa;">
                    <img th:src="${producto.rutaImagenCompleta}"
                         th:alt="${producto.nombre}"
                         class="producto-imagen img-fluid"
                         style="width: 100%; height: 100%; object-fit: cover;"
                         loading="lazy"
                         onload="this.style.opacity='1'"
                         onerror="this.onerror=null; this.src='https://via.placeholder.com/300x220/CCCCCC/666666?text=Imagen+No+Disponible'"
                         data-producto-id="${producto.id}">
                    
                    <!-- ‚úÖ Loading placeholder -->
                    <div class="loading-placeholder" 
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title" th:text="${producto.nombre}"></h5>
                    
                    <div class="mt-auto">
                        <p class="card-text text-success fw-bold mb-2">
                            $<span th:text="${#numbers.formatDecimal(producto.precio, 1, 2)}"></span>
                            <small class="text-danger text-decoration-line-through ms-2"
                                   th:if="${producto.precioOriginal != null && producto.precioOriginal > producto.precio}"
                                   th:text="'$' + ${#numbers.formatDecimal(producto.precioOriginal, 1, 2)}">
                            </small>
                        </p>
                        
                        <div class="d-flex gap-2">
                            <a th:href="@{'/producto/' + ${producto.id}}"
                               class="btn btn-outline-primary btn-sm flex-fill">
                                üëÅÔ∏è Ver Detalles
                            </a>
                            
                            <button class="btn btn-primary btn-sm flex-fill btn-agregar-carrito"
                                    th:data-id="${producto.id}"
                                    th:data-nombre="${producto.nombre}"
                                    onclick="agregarAlCarrito(this); return false;">
                                üõí A√±adir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ Mensaje si no hay productos -->
    <div th:if="${#lists.isEmpty(productos)}" class="alert alert-warning text-center py-5">
        <h4>No se encontraron productos</h4>
        <p>Intenta con otros filtros o categor√≠as.</p>
        <a th:href="@{/catalogo}" class="btn btn-primary">Ver todos los productos</a>
    </div>

</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- ‚úÖ Script optimizado para evitar parpadeos -->
<script>
// ‚úÖ VARIABLES GLOBALES para control
let catalogoCargado = false;
let imagenesCargando = new Set();
let eventListenersAgregados = false;

// ‚úÖ Funci√≥n para cargar im√°genes de manera inteligente
function cargarImagenInteligente(imgElement) {
    if (!imgElement.dataset.loaded) {
        const productoId = imgElement.dataset.productoId;
        
        // Si ya est√° cargando, salir
        if (imagenesCargando.has(productoId)) return;
        imagenesCargando.add(productoId);
        
        // Crear imagen fantasma para pre-carga
        const tempImg = new Image();
        tempImg.onload = function() {
            imgElement.src = this.src;
            imgElement.style.opacity = '0';
            imgElement.style.transition = 'opacity 0.3s ease';
            
            // Mostrar imagen suavemente
            setTimeout(() => {
                imgElement.style.opacity = '1';
                imgElement.dataset.loaded = true;
                
                // Ocultar placeholder
                const placeholder = imgElement.parentElement.querySelector('.loading-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
                
                imagenesCargando.delete(productoId);
            }, 50);
        };
        
        tempImg.onerror = function() {
            // Usar placeholder en caso de error
            imgElement.src = 'https://via.placeholder.com/300x220/CCCCCC/666666?text=Imagen+No+Disponible';
            imgElement.dataset.loaded = true;
            
            const placeholder = imgElement.parentElement.querySelector('.loading-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            imagenesCargando.delete(productoId);
        };
        
        tempImg.src = imgElement.src;
    }
}

// ‚úÖ Funci√≥n para agregar al carrito (optimizada)
function agregarAlCarrito(boton) {
    if (boton.disabled) return;
    
    const productoId = boton.dataset.id;
    const productoNombre = boton.dataset.nombre;
    
    // Mostrar modal o prompt para seleccionar talla y cantidad
    mostrarSelectorTallaYCantidad(productoId, productoNombre, boton);
}

// ‚úÖ Funci√≥n para mostrar selector de talla y cantidad
function mostrarSelectorTallaYCantidad(productoId, productoNombre, boton) {
    // Crear un modal simple con HTML
    const modal = document.createElement('div');
    modal.id = 'selectorModal-' + productoId;
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%;">
            <h5 style="margin-bottom: 20px;">Agregar "${productoNombre}" al carrito</h5>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Selecciona tu Talla:</label>
                <select id="tallaSelect" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    <option value="">-- Selecciona una talla --</option>
                    <option value="35">35</option>
                    <option value="36">36</option>
                    <option value="37">37</option>
                    <option value="38">38</option>
                    <option value="39">39</option>
                    <option value="40">40</option>
                    <option value="41">41</option>
                    <option value="42">42</option>
                    <option value="43">43</option>
                    <option value="44">44</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Cantidad:</label>
                <input type="number" id="cantidadInput" min="1" max="5" value="1" 
                       style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="enviarAlCarrito(${productoId}, '${productoNombre}')" 
                        style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    ‚úÖ Agregar
                </button>
                <button onclick="cerrarSelector(${productoId})" 
                        style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    ‚úï Cancelar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.getElementById('tallaSelect').focus();
}

// ‚úÖ Funci√≥n para enviar al carrito
function enviarAlCarrito(productoId, productoNombre) {
    const talla = document.getElementById('tallaSelect').value;
    const cantidad = parseInt(document.getElementById('cantidadInput').value) || 1;
    
    if (!talla) {
        alert('Por favor selecciona una talla');
        return;
    }
    
    if (cantidad < 1 || cantidad > 5) {
        alert('La cantidad debe ser entre 1 y 5');
        return;
    }
    
    console.log(`üõí Agregando producto ${productoId} - Talla: ${talla} - Cantidad: ${cantidad}`);
    
    fetch(`/carrito/agregar?productoId=${productoId}&talla=${talla}&cantidad=${cantidad}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Error en la respuesta del servidor');
    })
    .then(data => {
        cerrarSelector(productoId);
        
        if (data.success) {
            // Actualizar contador
            const contador = document.getElementById('carritoCountDesktop');
            if (contador) {
                contador.textContent = data.carritoCount || 0;
            }
            
            // Mensaje toast
            mostrarToast(`"${productoNombre}" agregado al carrito`, 'success');
        } else {
            mostrarToast(data.message || 'Error al agregar producto', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarToast('Error de conexi√≥n. Intenta nuevamente.', 'error');
        cerrarSelector(productoId);
    });
}

// ‚úÖ Funci√≥n para cerrar selector
function cerrarSelector(productoId) {
    const modal = document.getElementById('selectorModal-' + productoId);
    if (modal) {
        modal.remove();
    }

// ‚úÖ Funci√≥n para mostrar toast (reemplaza alert())
function mostrarToast(mensaje, tipo = 'info') {
    const toastId = 'toast-' + Date.now();
    const color = tipo === 'success' ? '#28a745' : tipo === 'error' ? '#dc3545' : '#17a2b8';
    
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${color};
        color: white;
        padding: 12px 20px;
        border-radius: 5px;
        z-index: 9999;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 300px;
    `;
    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.2em;">${tipo === 'success' ? '‚úÖ' : '‚ùå'}</span>
            <span>${mensaje}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-eliminar despu√©s de 3 segundos
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            if (document.getElementById(toastId)) {
                document.getElementById(toastId).remove();
            }
        }, 300);
    }, 3000);
}

// ‚úÖ Inicializaci√≥n controlada
document.addEventListener('DOMContentLoaded', function() {
    if (catalogoCargado) {
        console.log('‚ö†Ô∏è El cat√°logo ya est√° inicializado');
        return;
    }
    
    catalogoCargado = true;
    console.log('üöÄ Inicializando cat√°logo...');
    
    // ‚úÖ 1. Cargar im√°genes de manera inteligente
    const imagenes = document.querySelectorAll('.producto-imagen');
    console.log(`üì∏ Encontradas ${imagenes.length} im√°genes`);
    
    // Cargar im√°genes con retraso escalonado para evitar sobrecarga
    imagenes.forEach((img, index) => {
        setTimeout(() => {
            cargarImagenInteligente(img);
        }, index * 100); // Espaciar carga
    });
    
    // ‚úÖ 2. Configurar filtros (solo una vez)
    if (!eventListenersAgregados) {
        // Configurar bot√≥n de b√∫squeda
        const btnBuscar = document.getElementById('btnBuscar');
        if (btnBuscar) {
            btnBuscar.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('filtroForm').submit();
            });
        }
        
        // Configurar input de b√∫squeda (Enter para buscar)
        const inputBusqueda = document.getElementById('busquedaInput');
        if (inputBusqueda) {
            inputBusqueda.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('filtroForm').submit();
                }
            });
        }
        
        const selects = ['categoriaSelect', 'precioSelect', 'ordenSelect'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.addEventListener('change', function() {
                    console.log(`üîç Filtro cambiado: ${this.name}=${this.value}`);
                    // Agregar delay para evitar m√∫ltiples env√≠os r√°pidos
                    clearTimeout(this._timeout);
                    this._timeout = setTimeout(() => {
                        this.form.submit();
                    }, 300);
                });
            }
        });
        
        // ‚úÖ 3. Configurar botones de carrito
        const botonesCarrito = document.querySelectorAll('.btn-agregar-carrito');
        console.log(`üõí Encontrados ${botonesCarrito.length} botones de carrito`);
        
        botonesCarrito.forEach(boton => {
            // Reemplazar onclick por event listener
            const productoId = boton.dataset.id;
            boton.onclick = null; // Remover onclick antiguo
            
            boton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                agregarAlCarrito(this);
            });
        });
        
        eventListenersAgregados = true;
    }
    
    // ‚úÖ 4. Agregar estilos para animaciones
    if (!document.getElementById('animations-style')) {
        const style = document.createElement('style');
        style.id = 'animations-style';
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .producto-imagen {
                transition: opacity 0.3s ease, transform 0.3s ease;
            }
            .producto-imagen:hover {
                transform: scale(1.03);
            }
        `;
        document.head.appendChild(style);
    }
    
    console.log('‚úÖ Cat√°logo inicializado correctamente');
});

// ‚úÖ Prevenir recargas accidentales
window.addEventListener('beforeunload', function(e) {
    // Solo prevenir si hay im√°genes cargando
    if (imagenesCargando.size > 0) {
        e.preventDefault();
        e.returnValue = 'Hay im√°genes cargando. ¬øSeguro que quieres salir?';
    }
});

// ‚úÖ Manejar visibilidad de p√°gina
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        // Si la p√°gina vuelve a ser visible, verificar im√°genes
        const imagenes = document.querySelectorAll('.producto-imagen:not([data-loaded])');
        imagenes.forEach(img => cargarImagenInteligente(img));
    }
});
</script>

</body>
</html>